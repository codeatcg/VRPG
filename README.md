# VRPG
an interactive web viewer for reference pangenome graphs

|  |  |
| --- | --- |
| <img src="https://github.com/codeatcg/VRPG/blob/main/static/images/window2.png" width=600px/> | <img src="https://github.com/codeatcg/VRPG/blob/main/static/images/description3.png" width=400px/> |

Figrue on the left was based on vrpg-v0.1.1 and the particular assembly path was not highlighted by arrow lines. Figrues on the right were picked from drawings by latest version of vrpg.

# Description  
VRPG is an interactive web viewer for pangenome graph. It was initially designed to navigate the whole pangenome graph in reference Graph Fragment Assembly (rGFA) format. Now Graph Fragment Assembly (GFA v1.x) format is also supported. This is implemented by converting the GFA format to a format similar to rGFA. VRPG is fast, even for large and complex human pangenome graph generated with many whole genome assemblies. The reference nodes are aligned along the center line of the view window and surrounded by non-reference nodes. The reference line that consists of a series of reference nodes holds the stable coordinate system, just like the traditional linear reference. It’s beneficial to scanning all kinds of variations in the graph and relating them to biological function from previous studies based on a single linear reference. A website shipping four pangenome graphs (one for yeast and three for human) is available at https://www.evomicslab.org/app/vrpg/. The Saccharomyces cerevisiae pangenome graph was generated with 163 assemblies and The three Homo sapiens pangenome graphs with 90 whole genome assemblies for each were constructed by <a href="https://humanpangenome.org/">HPRC</a>  by three different pipelines (Minigraph, Minigraph-CACTUS and PGGB). Users can also deploy the web application and view their own data.  

**Note:** the released version 0.1.1 is not the latest. For the latest version rGFA and GFAv1x formats are both supported. Moreover a particular assembly path was highlighted by solid arrow lines (denote edges) and dot lines (denote nodes). The dot lines encoded coverage information at the same time by different line width. The 'Display mode' menue was changed to 'Layout' and a new option 'cola' was appended. Squeezed and expand layouts were upon D3.js and cola layout was upon WebCola. The method to index the graph was also modified and the server response time was improved further.    

When navigating the pangenome graph generated by Minigraph-CACTUS and PGGB the window size should not be set too large. This is becaues these graphs include large amounts of SNPs and INDELs. If the window size is too large these small variants will be difficult to recognize and on the other hand, too many nodes may cause the browser failing to render the page. Maybe in next version of VRPG we will mask these small variants for views at large scale. For now graphs generated by Minigraph are more suitable for these tasks.  

For cola layout the node size is more proportional to the segment sequence size. But it may take a little longer time to stabilize. When the number of nodes in a window is small cola layout can be tested.  

# Installation  
Python3 (>=3.6) and pip environment are required.  

```
# For installing a historical version please access https://github.com/codeatcg/VRPG/releases and download the source code.

# install the latest version
# gcc >= 4.9
pip install Django==3.2.4  pybind11
git clone https://github.com/codeatcg/VRPG --recursive  
cd VRPG/module
make

```

# Prepare your data  

The naming scheme of assembly should follow <a href="https://github.com/pangenome/PanSN-spec">PanSN prefix naming pattern</a>. Briefly, the assembly's name consists of sample name, delimiter, and haplotype name, e.g., sampleA#0. But it's a little looser in VRPG. It's not required that the haplotype name must be numeric, characters are also allowed.  

## rGFA format graph  

### Pangenome graph already exists  

The assemblies to graph mapping files are required. If these files do not exist the assembly can't be highlighted in the drawing. These files can be generated by minigraph by using command '-cxasm --vc'. Then run the following command to get files required by VRPG.  

```
Python script/vrpg_preprocess.py --rGFA all.gfa --gafList gaf_file.list --outDir out_folder --index
```

#### gaf_file.list file is formatted as follows: 

sample1#H1	sample1.H1.gaf  
sample2#0	sample2.0.gaf  
sample3#1	sample3.1.gaf  
sample3#2	sample3.2.gaf  

### Pangenome graph not exists  

Run the following command to create pangenome graph and generate files required by VRPG.  

```
Python script/vrpg_preprocess.py –-minigraph '/software/minigraph' --assList ass_file.list –-outDir out_folder --index
```

#### ass_file.list file is formatted as follows:  
sample1#H1	sample1.H1.fa  
sample2#0	sample2.0.fa  
sample3#1	sample3.1.fa  
sample3#2	sample3.2.fa  

**Note**, '/software/minigraph' represents the absolute path of minigraph executable file. Assembly in first line in file ass_file.list will be taken as reference.  

## GFA format graph

For graphs in GFA format that can be processed by VRPG segment names should be numeric. Fortunately, graphs generated by Minigraph-CACUTUS and PGGB have this feature. If the segment names are not numeric users need to modify the graph first. Also notice that all path names in the graph should follow <a href="https://github.com/pangenome/PanSN-spec">PanSN prefix naming pattern</a>. If the path names don’t obey the rule the graph needs to be modified. This can be avoided by using proper assembly names before constructing the graph. If the graph satisfied the conditions described above run the following command to get files required by VRPG.  

```
module/gfa2view --GFA in.gfa --ref refName --outDir output_dir --index --range 2000 --thread 10

```
**Note**, For the current version of 'gfa2view' memory consumption is proportion to number of threads. A trade-off between speed and and memory consumption needs to be considered.  

If only a particular set of reference chromosomes or contigs are considered for view the option ‘--refChr’ can be used to save running time. For this option a file containing a reference chromosome or contig name (not contain sample name or haplotype name) per line is required.  


# Execution  
## Local server or personal computer with Linux/Ubuntu operating system  

1. Move all output files in directory 'upload' generated during data preparation to the empty folder 'upload' of VRPG.
2. Start the development server of Django  

```
python3 manage.py runserver  

If all is well you will see the output:  
Django version 3.2.4, using settings 'primers_project.settings'  
Starting development server at http://127.0.0.1:8000/  
```

3. Then open http://127.0.0.1:8000/app/vrpg/ in your browser and you will see the drawing of the pangenome graph.  

**Note**, For large pangenome graph it's better to prepare data in a computing server and then transfer the data to local 'upload' folder of VRPG.

## Remote server  

If server is running on a different machine start the server by running

```
python3 manage.py runserver 0.0.0.0:8000
```
Please make sure the firewall is closed. Then open <a>http:\<IP of server\>:8000/app/vrpg/</a>.

If you are familiar with nginx or apache you can also deploy VRPG by using any of them.

# Tips  
1. The edge can be highlighted by clicking on it. Remove the highlight by just click on it again.
2. For graphs generated by PGGB the duplicate sequence in assigned reference assembly may be collapsed. For the collapsed region new nodes and edges will be inserted into the graph by vrpg to make the reference keeping coordinate system same to the traditional single linear reference. But the new nodes and edges will be not inserted into the path. If there are only reference nodes in a region and the highlighted reference path don’t pass these nodes the region may indicate a collapse. Another feature of these regions is that the numeric identifier of the segment that the node represents is generally much larger than the identifiers of the reference segments in the surrounding region.  
<img src="https://github.com/codeatcg/VRPG/blob/main/static/images/ref_collapse3.png"/>

